% load streamlines; for k = 1:10, plot_streamlines(D{k}.sol, 20, k); end
function plot_streamlines(sol, r_, k)

s = streamfunc(sol);
[R, T] = ndgrid(s.grid.r, s.grid.t);
I = s.grid.r < r_;
R = R(I, :);
T = T(I, :);
Z = s.Psi(I, :);
X = R.*cos(T);
Y = R.*sin(T);
c = s.beta*0.05;
c = linspace(-c, c, 25);

fmt = '-deps2';

figure(1); clf;
show(X, Y, Z, c, r_, s.beta, 'Numerical: \\beta = %.2f')
print(fmt, sprintf('N%d', k))

figure(2); clf;
psi = analytic(s.beta, R, T, s.gamma, s.alpha);
show(X, Y, psi, c, r_, s.beta, 'Analytical: \\beta = %.2f')
print(fmt, sprintf('A%d', k))

function show(X, Y, Z, c, r_, b, fmt)
hold on;
colormap(ones(2, 3) * 0.5)
% plot([-r_ r_], [0 0], '-', 'Color', [1 1 1]*0.5)
Z = Z - eps;
contour([X X], [Y -Y], [Z -Z], c);
xlim([-1 1]*r_/2)
ylim([-.1 .1]*r_/4)
axis equal
set(gca, 'XTick', [], 'YTick', [])
grid on;
sphere;
title(sprintf(fmt, b)); hold off;

function psi = analytic(b, r, t, g, a)
psi = b.^3.*(r.^2.*sin(t).^2.*((11.*log((g.^(1./2) + 1)./(2.*g.^(1./2))))./320 + 9./(640.*(g.^(1./2) + 1).^2) - 124./(5.*(512.*g.^(1./2) + 512)) + (61.*a.^2.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2).^2)./160 + (83.*a.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2))./320 - (88.*a.*log(1./(2.*g.^(1./2)) + 1./2))./(5.*(256.*g.^(1./2) + 256)) + 209./3360) - (sin(t).^2.*(1848.*r.^6.*sin(t).^2 - 2079.*r.^3.*sin(t).^2 - 7.*sin(t).^2 + 924.*r.^3 + 10))./(19712.*r.^5) - (sin(t).^2.*((29.*log((g.^(1./2) + 1)./(2.*g.^(1./2))))./320 - 9./(128.*(g.^(1./2) + 1).^2) - 68./(512.*g.^(1./2) + 512) + (59.*a.^2.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2).^2)./80 + (11.*a.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2))./20 + (a.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*((27.*log(1./(2.*g.^(1./2)) + 1./2).*(2.*a.*log(1./(2.*g.^(1./2)) + 1./2) + 1))./8 - 81./(16.*g.^(1./2) + 16)))./40 - (104.*a.*log(1./(2.*g.^(1./2)) + 1./2))./(256.*g.^(1./2) + 256) + 35./264))./r + (sin(t).^4.*((9.*log((g.^(1./2) + 1)./(2.*g.^(1./2))))./128 - 27./(256.*(g.^(1./2) + 1).^2) - 54./(512.*g.^(1./2) + 512) + (57.*a.^2.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2).^2)./128 + (93.*a.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2))./256 + (a.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*((27.*log(1./(2.*g.^(1./2)) + 1./2).*(2.*a.*log(1./(2.*g.^(1./2)) + 1./2) + 1))./8 - 81./(16.*g.^(1./2) + 16)))./32 - (108.*a.*log(1./(2.*g.^(1./2)) + 1./2))./(256.*g.^(1./2) + 256) + 761./5632))./r + (sin(t).^2.*((a.*log(1./(2.*g.^(1./2)) + 1./2))./8 - 1./8).*(1./(2.*r) - (3.*r)./2 + r.^2))./2 + (sin(t).^2.*(5.*cos(t).^2 - 1).*((9.*log((g.^(1./2) + 1)./(2.*g.^(1./2))))./640 - 27./(1280.*(g.^(1./2) + 1).^2) - 54./(5.*(512.*g.^(1./2) + 512)) + (57.*a.^2.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2).^2)./640 + (93.*a.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*log(1./(2.*g.^(1./2)) + 1./2))./1280 + (a.*log((g.^(1./2) + 1)./(2.*g.^(1./2))).*((27.*log(1./(2.*g.^(1./2)) + 1./2).*(2.*a.*log(1./(2.*g.^(1./2)) + 1./2) + 1))./8 - 81./(16.*g.^(1./2) + 16)))./160 - (108.*a.*log(1./(2.*g.^(1./2)) + 1./2))./(5.*(256.*g.^(1./2) + 256)) + 829./28160))./r.^3) + b.*sin(t).^2.*log(1./(2.*g.^(1./2)) + 1./2).*(1./r - r.^2) - b.^2.*cos(t).*sin(t).^2.*((3.*log(1./(2.*g.^(1./2)) + 1./2).*(2.*a.*log(1./(2.*g.^(1./2)) + 1./2) + 1))./8 - 9./(16.*g.^(1./2) + 16)).*(1./r.^2 - 1);
I = true(size(r)); 
I(:, [1 end]) = false;
psi(I) = psi(I) ./ (r(I) .* sin(t(I)));

function sphere()
t = linspace(0, 2*pi, 100);
fill(cos(t), sin(t), 'k');
